# Reusable workflow for updating Homebrew formulas
# Called by other Data-Wise repositories when they release new versions
#
# Usage in caller repo:
#   jobs:
#     update-homebrew:
#       uses: Data-Wise/homebrew-tap/.github/workflows/update-formula.yml@main
#       with:
#         formula_name: aiterm
#         version: ${{ needs.release.outputs.version }}
#         sha256: ${{ needs.release.outputs.sha256 }}
#       secrets:
#         tap_token: ${{ secrets.HOMEBREW_TAP_GITHUB_TOKEN }}

name: Update Formula

on:
  workflow_call:
    inputs:
      formula_name:
        description: 'Name of the formula (e.g., aiterm, nexus-cli)'
        required: true
        type: string
      version:
        description: 'Version number (without v prefix)'
        required: true
        type: string
      sha256:
        description: 'SHA256 hash of the release tarball'
        required: true
        type: string
      source_type:
        description: 'Source type: github or pypi'
        required: false
        type: string
        default: 'github'
      auto_merge:
        description: 'Auto-merge the PR (requires admin token)'
        required: false
        type: boolean
        default: false
    secrets:
      tap_token:
        description: 'GitHub token with repo access to homebrew-tap'
        required: true

jobs:
  update-formula:
    name: Update ${{ inputs.formula_name }} to v${{ inputs.version }}
    runs-on: ubuntu-latest

    steps:
      - name: Checkout homebrew-tap
        uses: actions/checkout@v4
        with:
          repository: Data-Wise/homebrew-tap
          token: ${{ secrets.tap_token }}
          ref: main

      - name: Update formula version and SHA
        run: |
          FORMULA="Formula/${{ inputs.formula_name }}.rb"

          if [ ! -f "$FORMULA" ]; then
            echo "âŒ Formula not found: $FORMULA"
            exit 1
          fi

          echo "ðŸ“¦ Updating $FORMULA to v${{ inputs.version }}"

          if [ "${{ inputs.source_type }}" = "pypi" ]; then
            # PyPI package - update version in URL pattern
            # Example: nexus_cli-0.5.0.tar.gz â†’ nexus_cli-0.5.1.tar.gz
            PACKAGE_NAME=$(echo "${{ inputs.formula_name }}" | tr '-' '_')
            sed -i "s|/${PACKAGE_NAME}-[0-9][^/]*\.tar\.gz|/${PACKAGE_NAME}-${{ inputs.version }}.tar.gz|g" "$FORMULA"
          else
            # GitHub tarball - update version in URL
            sed -i "s|/v[0-9][^/]*\.tar\.gz|/v${{ inputs.version }}.tar.gz|g" "$FORMULA"
          fi

          # Update SHA256 (first occurrence - main package)
          sed -i "0,/sha256 \"[^\"]*\"/s|sha256 \"[^\"]*\"|sha256 \"${{ inputs.sha256 }}\"|" "$FORMULA"

          # Update version in test block if present
          sed -i "s|assert_match \"[0-9.]*\"|assert_match \"${{ inputs.version }}\"|g" "$FORMULA"

          echo ""
          echo "âœ… Updated formula:"
          head -15 "$FORMULA"

      - name: Create Pull Request
        id: create-pr
        uses: peter-evans/create-pull-request@v7
        with:
          token: ${{ secrets.tap_token }}
          commit-message: "${{ inputs.formula_name }}: update to v${{ inputs.version }}"
          title: "${{ inputs.formula_name }}: update to v${{ inputs.version }}"
          body: |
            Automated formula update.

            **Package:** `${{ inputs.formula_name }}`
            **Version:** `v${{ inputs.version }}`
            **SHA256:** `${{ inputs.sha256 }}`
            **Source:** ${{ inputs.source_type }}

            ---
            _Generated by [homebrew-tap reusable workflow](https://github.com/Data-Wise/homebrew-tap/actions)_
          branch: formula/${{ inputs.formula_name }}-${{ inputs.version }}
          base: main
          delete-branch: true

      - name: Auto-merge PR
        if: inputs.auto_merge && steps.create-pr.outputs.pull-request-number
        env:
          GH_TOKEN: ${{ secrets.tap_token }}
        run: |
          PR_NUMBER="${{ steps.create-pr.outputs.pull-request-number }}"
          echo "ðŸ”€ Auto-merging PR #$PR_NUMBER"

          # Wait for any checks to complete
          sleep 5

          # Merge the PR
          gh pr merge "$PR_NUMBER" --squash --delete-branch --repo Data-Wise/homebrew-tap

          echo "âœ… PR #$PR_NUMBER merged successfully"

      - name: Summary
        run: |
          echo "## ðŸº Homebrew Formula Updated" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Field | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|-------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| Formula | \`${{ inputs.formula_name }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| Version | \`v${{ inputs.version }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| Source | ${{ inputs.source_type }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Auto-merge | ${{ inputs.auto_merge }} |" >> $GITHUB_STEP_SUMMARY
          if [ -n "${{ steps.create-pr.outputs.pull-request-url }}" ]; then
            echo "| PR | ${{ steps.create-pr.outputs.pull-request-url }} |" >> $GITHUB_STEP_SUMMARY
          fi
