# Reusable workflow for updating Homebrew formulas
# Called by other Data-Wise repositories when they release new versions
#
# Usage in caller repo:
#   jobs:
#     update-homebrew:
#       uses: Data-Wise/homebrew-tap/.github/workflows/update-formula.yml@main
#       with:
#         formula_name: aiterm
#         version: ${{ needs.release.outputs.version }}
#         sha256: ${{ needs.release.outputs.sha256 }}
#       secrets:
#         tap_token: ${{ secrets.HOMEBREW_TAP_GITHUB_TOKEN }}

name: Update Formula

on:
  # Manual trigger for testing (no inputs required = dry-run safe)
  workflow_dispatch:
    inputs:
      formula_name:
        description: 'Formula name (e.g., aiterm)'
        required: true
        type: string
      version:
        description: 'Version (without v prefix)'
        required: true
        type: string
      sha256:
        description: 'SHA256 of release tarball'
        required: true
        type: string
      source_type:
        description: 'Source type'
        required: false
        type: string
        default: 'github'

  # Reusable workflow (called by other repos on release)
  workflow_call:
    inputs:
      formula_name:
        description: 'Name of the formula (e.g., aiterm, nexus-cli)'
        required: true
        type: string
      version:
        description: 'Version number (without v prefix)'
        required: true
        type: string
      sha256:
        description: 'SHA256 hash of the release tarball'
        required: true
        type: string
      source_type:
        description: 'Source type: github, pypi, npm, or cran'
        required: false
        type: string
        default: 'github'
      auto_merge:
        description: 'Auto-merge: true = direct push to main, false = create PR'
        required: false
        type: boolean
        default: false
      command_count:
        description: 'Dynamic command count for formula strings (optional)'
        required: false
        type: string
        default: ''
      agent_count:
        description: 'Dynamic agent count for formula strings (optional)'
        required: false
        type: string
        default: ''
      skill_count:
        description: 'Dynamic skill count for formula strings (optional)'
        required: false
        type: string
        default: ''
    secrets:
      tap_token:
        description: 'GitHub PAT with repo access to homebrew-tap (fallback if no GitHub App)'
        required: false
      app_id:
        description: 'GitHub App ID for Data-Wise Homebrew Automation'
        required: false
      app_private_key:
        description: 'GitHub App private key (PEM)'
        required: false

jobs:
  update-formula:
    name: Update ${{ inputs.formula_name }} to v${{ inputs.version }}
    runs-on: ubuntu-latest

    steps:
      # Prefer GitHub App token (short-lived, scoped) over PAT
      # Note: secrets can't be referenced in if: conditions for reusable
      # workflows called cross-repo â€” use env vars to check availability
      - name: Generate GitHub App token
        id: app-token
        env:
          HAS_APP_ID: ${{ secrets.app_id }}
          HAS_APP_KEY: ${{ secrets.app_private_key }}
        if: env.HAS_APP_ID != '' && env.HAS_APP_KEY != ''
        uses: actions/create-github-app-token@v1
        with:
          app-id: ${{ secrets.app_id }}
          private-key: ${{ secrets.app_private_key }}
          owner: Data-Wise
          repositories: homebrew-tap

      - name: Checkout homebrew-tap
        uses: actions/checkout@v4
        with:
          repository: Data-Wise/homebrew-tap
          token: ${{ steps.app-token.outputs.token || secrets.tap_token }}
          ref: main
          persist-credentials: false

      - name: Update formula version and SHA
        env:
          FORMULA_NAME: ${{ inputs.formula_name }}
          VERSION: ${{ inputs.version }}
          SHA256: ${{ inputs.sha256 }}
          SOURCE_TYPE: ${{ inputs.source_type }}
          CMD_COUNT: ${{ inputs.command_count }}
          AGENT_COUNT: ${{ inputs.agent_count }}
          SKILL_COUNT: ${{ inputs.skill_count }}
        run: |
          FORMULA="Formula/${FORMULA_NAME}.rb"

          if [ ! -f "$FORMULA" ]; then
            echo "âŒ Formula not found: $FORMULA"
            exit 1
          fi

          echo "ðŸ“¦ Updating $FORMULA to v${VERSION}"

          case "$SOURCE_TYPE" in
            pypi)
              # PyPI package - update version in URL pattern
              PACKAGE_NAME=$(echo "$FORMULA_NAME" | tr '-' '_')
              sed -i "s|/${PACKAGE_NAME}-[0-9][^/]*\.tar\.gz|/${PACKAGE_NAME}-${VERSION}.tar.gz|g" "$FORMULA"
              ;;
            npm)
              # npm package - update version in registry URL (tgz pattern)
              sed -i "s|/-/${FORMULA_NAME}-[0-9][^/]*\.tgz|/-/${FORMULA_NAME}-${VERSION}.tgz|g" "$FORMULA"
              ;;
            cran)
              # CRAN package - update version in archive URL
              sed -i "s|/${FORMULA_NAME}_[0-9][^/]*\.tar\.gz|/${FORMULA_NAME}_${VERSION}.tar.gz|g" "$FORMULA"
              ;;
            *)
              # GitHub tarball (default) - update version in URL
              sed -i "s|/v[0-9][^/]*\.tar\.gz|/v${VERSION}.tar.gz|g" "$FORMULA"
              ;;
          esac

          # Update SHA256 (first occurrence - main package)
          sed -i "0,/sha256 \"[^\"]*\"/s|sha256 \"[^\"]*\"|sha256 \"${SHA256}\"|" "$FORMULA"

          # Update version in test block if present
          sed -i "s|assert_match \"[0-9.]*\"|assert_match \"${VERSION}\"|g" "$FORMULA"

          # Update dynamic metadata if provided (backward-compatible: no-op when empty)
          if [ -n "$CMD_COUNT" ]; then
            # Update desc line: "NNN commands" pattern
            sed -i "s|[0-9]\+ commands|${CMD_COUNT} commands|g" "$FORMULA"
            echo "  Updated command count to $CMD_COUNT"
          fi

          if [ -n "$AGENT_COUNT" ]; then
            sed -i "s|[0-9]\+ agents|${AGENT_COUNT} agents|g" "$FORMULA"
            echo "  Updated agent count to $AGENT_COUNT"
          fi

          if [ -n "$SKILL_COUNT" ]; then
            sed -i "s|[0-9]\+ skills|${SKILL_COUNT} skills|g" "$FORMULA"
            echo "  Updated skill count to $SKILL_COUNT"
          fi

          echo ""
          echo "âœ… Updated formula:"
          head -15 "$FORMULA"

      - name: Validate formula syntax
        continue-on-error: true
        env:
          FORMULA_NAME: ${{ inputs.formula_name }}
        run: |
          brew style "Formula/${FORMULA_NAME}.rb" || echo "âš ï¸ Style check found issues (non-blocking)"

      # When auto_merge is true, commit directly to main (no PR race condition)
      # persist-credentials: false above prevents actions/checkout from setting
      # an extraheader with the caller's GITHUB_TOKEN, so we auth via remote URL
      - name: Direct push to main
        if: inputs.auto_merge
        env:
          FORMULA_NAME: ${{ inputs.formula_name }}
          VERSION: ${{ inputs.version }}
          TAP_TOKEN: ${{ steps.app-token.outputs.token || secrets.tap_token }}
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          PUSH_URL="https://x-access-token:${TAP_TOKEN}@github.com/Data-Wise/homebrew-tap.git"
          git remote set-url origin "$PUSH_URL"
          git add "Formula/${FORMULA_NAME}.rb"
          git commit -m "${FORMULA_NAME}: update to v${VERSION}"

          # Unset GITHUB_TOKEN so the runner's credential helper doesn't
          # intercept and use the caller workflow's token (which lacks push
          # access to homebrew-tap). Auth comes from the URL-embedded TAP_TOKEN.
          unset GITHUB_TOKEN

          for attempt in 1 2 3; do
            if git push origin HEAD:main; then
              echo "âœ… Pushed to main (attempt $attempt)"
              exit 0
            fi
            echo "âš ï¸ Push failed (attempt $attempt/3), rebasing..."
            git pull --rebase origin main
          done

          echo "âŒ Failed to push after 3 attempts"
          exit 1

      # When auto_merge is false, create a PR for manual review
      - name: Create Pull Request
        id: create-pr
        if: ${{ !inputs.auto_merge }}
        uses: peter-evans/create-pull-request@v7
        with:
          token: ${{ steps.app-token.outputs.token || secrets.tap_token }}
          commit-message: "${{ inputs.formula_name }}: update to v${{ inputs.version }}"
          title: "${{ inputs.formula_name }}: update to v${{ inputs.version }}"
          body: |
            Automated formula update.

            **Package:** `${{ inputs.formula_name }}`
            **Version:** `v${{ inputs.version }}`
            **SHA256:** `${{ inputs.sha256 }}`
            **Source:** ${{ inputs.source_type }}

            ---
            _Generated by [homebrew-tap reusable workflow](https://github.com/Data-Wise/homebrew-tap/actions)_
          branch: formula/${{ inputs.formula_name }}-${{ inputs.version }}
          base: main
          delete-branch: true

      - name: Summary
        env:
          FORMULA_NAME: ${{ inputs.formula_name }}
          VERSION: ${{ inputs.version }}
          SOURCE_TYPE: ${{ inputs.source_type }}
          AUTO_MERGE: ${{ inputs.auto_merge }}
          PR_URL: ${{ steps.create-pr.outputs.pull-request-url }}
        run: |
          echo "## ðŸº Homebrew Formula Updated" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Field | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|-------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| Formula | \`${FORMULA_NAME}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| Version | \`v${VERSION}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| Source | ${SOURCE_TYPE} |" >> $GITHUB_STEP_SUMMARY
          echo "| Method | $([ "$AUTO_MERGE" = "true" ] && echo "Direct push" || echo "Pull request") |" >> $GITHUB_STEP_SUMMARY
          if [ -n "$PR_URL" ]; then
            echo "| PR | ${PR_URL} |" >> $GITHUB_STEP_SUMMARY
          fi
