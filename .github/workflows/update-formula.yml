# Reusable workflow for updating Homebrew formulas
# Called by other Data-Wise repositories when they release new versions
#
# Usage in caller repo:
#   jobs:
#     update-homebrew:
#       uses: Data-Wise/homebrew-tap/.github/workflows/update-formula.yml@main
#       with:
#         formula_name: aiterm
#         version: ${{ needs.release.outputs.version }}
#         sha256: ${{ needs.release.outputs.sha256 }}
#       secrets:
#         tap_token: ${{ secrets.HOMEBREW_TAP_GITHUB_TOKEN }}

name: Update Formula

on:
  workflow_call:
    inputs:
      formula_name:
        description: 'Name of the formula (e.g., aiterm, nexus-cli)'
        required: true
        type: string
      version:
        description: 'Version number (without v prefix)'
        required: true
        type: string
      sha256:
        description: 'SHA256 hash of the release tarball'
        required: true
        type: string
      source_type:
        description: 'Source type: github or pypi'
        required: false
        type: string
        default: 'github'
      auto_merge:
        description: 'Auto-merge: true = direct push to main, false = create PR'
        required: false
        type: boolean
        default: false
      command_count:
        description: 'Dynamic command count for formula strings (optional)'
        required: false
        type: string
        default: ''
      agent_count:
        description: 'Dynamic agent count for formula strings (optional)'
        required: false
        type: string
        default: ''
      skill_count:
        description: 'Dynamic skill count for formula strings (optional)'
        required: false
        type: string
        default: ''
    secrets:
      tap_token:
        description: 'GitHub token with repo access to homebrew-tap'
        required: true

jobs:
  update-formula:
    name: Update ${{ inputs.formula_name }} to v${{ inputs.version }}
    runs-on: ubuntu-latest

    steps:
      - name: Checkout homebrew-tap
        uses: actions/checkout@v4
        with:
          repository: Data-Wise/homebrew-tap
          token: ${{ secrets.tap_token }}
          ref: main

      - name: Update formula version and SHA
        env:
          FORMULA_NAME: ${{ inputs.formula_name }}
          VERSION: ${{ inputs.version }}
          SHA256: ${{ inputs.sha256 }}
          SOURCE_TYPE: ${{ inputs.source_type }}
          CMD_COUNT: ${{ inputs.command_count }}
          AGENT_COUNT: ${{ inputs.agent_count }}
          SKILL_COUNT: ${{ inputs.skill_count }}
        run: |
          FORMULA="Formula/${FORMULA_NAME}.rb"

          if [ ! -f "$FORMULA" ]; then
            echo "âŒ Formula not found: $FORMULA"
            exit 1
          fi

          echo "ðŸ“¦ Updating $FORMULA to v${VERSION}"

          if [ "$SOURCE_TYPE" = "pypi" ]; then
            # PyPI package - update version in URL pattern
            PACKAGE_NAME=$(echo "$FORMULA_NAME" | tr '-' '_')
            sed -i "s|/${PACKAGE_NAME}-[0-9][^/]*\.tar\.gz|/${PACKAGE_NAME}-${VERSION}.tar.gz|g" "$FORMULA"
          else
            # GitHub tarball - update version in URL
            sed -i "s|/v[0-9][^/]*\.tar\.gz|/v${VERSION}.tar.gz|g" "$FORMULA"
          fi

          # Update SHA256 (first occurrence - main package)
          sed -i "0,/sha256 \"[^\"]*\"/s|sha256 \"[^\"]*\"|sha256 \"${SHA256}\"|" "$FORMULA"

          # Update version in test block if present
          sed -i "s|assert_match \"[0-9.]*\"|assert_match \"${VERSION}\"|g" "$FORMULA"

          # Update dynamic metadata if provided (backward-compatible: no-op when empty)
          if [ -n "$CMD_COUNT" ]; then
            # Update desc line: "NNN commands" pattern
            sed -i "s|[0-9]\+ commands|${CMD_COUNT} commands|g" "$FORMULA"
            echo "  Updated command count to $CMD_COUNT"
          fi

          if [ -n "$AGENT_COUNT" ]; then
            sed -i "s|[0-9]\+ agents|${AGENT_COUNT} agents|g" "$FORMULA"
            echo "  Updated agent count to $AGENT_COUNT"
          fi

          if [ -n "$SKILL_COUNT" ]; then
            sed -i "s|[0-9]\+ skills|${SKILL_COUNT} skills|g" "$FORMULA"
            echo "  Updated skill count to $SKILL_COUNT"
          fi

          echo ""
          echo "âœ… Updated formula:"
          head -15 "$FORMULA"

      # When auto_merge is true, commit directly to main (no PR race condition)
      # Note: explicitly set remote URL with token because the caller workflow's
      # GITHUB_TOKEN can override the extraheader set by actions/checkout
      - name: Direct push to main
        if: inputs.auto_merge
        env:
          FORMULA_NAME: ${{ inputs.formula_name }}
          VERSION: ${{ inputs.version }}
          TAP_TOKEN: ${{ secrets.tap_token }}
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git remote set-url origin "https://x-access-token:${TAP_TOKEN}@github.com/Data-Wise/homebrew-tap.git"
          git add "Formula/${FORMULA_NAME}.rb"
          git commit -m "${FORMULA_NAME}: update to v${VERSION}"

          # Retry loop handles concurrent pushes (pull --rebase between attempts)
          for attempt in 1 2 3; do
            if git push origin main; then
              echo "âœ… Pushed to main (attempt $attempt)"
              exit 0
            fi
            echo "âš ï¸ Push failed (attempt $attempt/3), rebasing..."
            git pull --rebase origin main
          done

          echo "âŒ Failed to push after 3 attempts"
          exit 1

      # When auto_merge is false, create a PR for manual review
      - name: Create Pull Request
        id: create-pr
        if: ${{ !inputs.auto_merge }}
        uses: peter-evans/create-pull-request@v7
        with:
          token: ${{ secrets.tap_token }}
          commit-message: "${{ inputs.formula_name }}: update to v${{ inputs.version }}"
          title: "${{ inputs.formula_name }}: update to v${{ inputs.version }}"
          body: |
            Automated formula update.

            **Package:** `${{ inputs.formula_name }}`
            **Version:** `v${{ inputs.version }}`
            **SHA256:** `${{ inputs.sha256 }}`
            **Source:** ${{ inputs.source_type }}

            ---
            _Generated by [homebrew-tap reusable workflow](https://github.com/Data-Wise/homebrew-tap/actions)_
          branch: formula/${{ inputs.formula_name }}-${{ inputs.version }}
          base: main
          delete-branch: true

      - name: Summary
        env:
          FORMULA_NAME: ${{ inputs.formula_name }}
          VERSION: ${{ inputs.version }}
          SOURCE_TYPE: ${{ inputs.source_type }}
          AUTO_MERGE: ${{ inputs.auto_merge }}
          PR_URL: ${{ steps.create-pr.outputs.pull-request-url }}
        run: |
          echo "## ðŸº Homebrew Formula Updated" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Field | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|-------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| Formula | \`${FORMULA_NAME}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| Version | \`v${VERSION}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| Source | ${SOURCE_TYPE} |" >> $GITHUB_STEP_SUMMARY
          echo "| Method | $([ "$AUTO_MERGE" = "true" ] && echo "Direct push" || echo "Pull request") |" >> $GITHUB_STEP_SUMMARY
          if [ -n "$PR_URL" ]; then
            echo "| PR | ${PR_URL} |" >> $GITHUB_STEP_SUMMARY
          fi
